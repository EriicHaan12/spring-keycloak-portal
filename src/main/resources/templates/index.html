<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.w3.org/1999/xhtml">
<head>
    <meta charset="UTF-8">
    <title>Resource Server Main Page</title>
    <script>
        function getUserInfo() {
            console.log("getUserInfo 함수 호출됨");
            fetch('/getUserInfo')
                .then(response => {
                    if (!response.ok) {
                        throw new Error('Network response was not ok');
                    }
                    return response.json();
                })
                .then(data => {
                    console.log("사용자 정보:", data);
                    displayUserInfo(data);
                })
                .catch(error => console.error('Error fetching user info:', error));
        }

        function getAccessToken() {
            console.log("getAccessToken 함수 호출됨");
            fetch('/getAccessToken')
                .then(response => {
                    if (!response.ok) {
                        throw new Error('Network response was not ok');
                    }
                    return response.text();
                })
                .then(data => {
                    console.log("액세스 토큰:", data);
                    document.getElementById('accessToken').innerText = data;
                })
                .catch(error => console.error('Error fetching access token:', error));
        }

        function displayUserInfo(data) {
            var userInfoDiv = document.getElementById('userInfo');
            var table = document.createElement('table');
            table.border = '1';

            var tableHeader = document.createElement('thead');
            var headerRow = tableHeader.insertRow();
            for (var key in data[0]) {
                var headerCell = document.createElement('th');
                headerCell.textContent = key;
                headerRow.appendChild(headerCell);
            }
            table.appendChild(tableHeader);

            var tableBody = document.createElement('tbody');
            data.forEach(function(item) {
                var row = tableBody.insertRow();
                for (var key in item) {
                    var cell = row.insertCell();
                    if (key === 'access' || key === 'bruteForceStatus') {
                        cell.textContent = JSON.stringify(item[key]);
                    } else {
                        cell.textContent = item[key];
                    }
                }
                // bruteForceStatus.disabled가 true인 경우에만 잠금 해제 버튼 추가
                if (item.bruteForceStatus && item.bruteForceStatus.disabled) {
                    var unlockCell = row.insertCell();
                    var unlockButton = document.createElement('button');
                    unlockButton.textContent = 'Unlock';
                    unlockButton.onclick = function() {
                        unlockUser(item.id);
                    };
                    unlockCell.appendChild(unlockButton);
                }
            });
            table.appendChild(tableBody);

            while (userInfoDiv.firstChild) {
                userInfoDiv.removeChild(userInfoDiv.firstChild);
            }

            userInfoDiv.appendChild(table);
        }

        function unlockUser(userId) {
            console.log("unlockUser 함수 호출됨, userId:", userId);

            fetch(`/unlockUser/${userId}`, {
                method: 'DELETE',
            })
                .then(response => {
                    console.log("응답 상태 코드:", response.status);
                    console.log("응답 본문:", response);
                    if (!response.ok) {
                        throw new Error('Network response was not ok');
                    }
                    return response.text();
                })
                .then(data => {
                    console.log("사용자 잠금 해제됨:", data);
                    getUserInfo();  // 업데이트된 사용자 정보를 다시 가져옴
                })
                .catch(error => console.error('Error unlocking user:', error));
        }

    </script>
</head>
<body>
<h1>Resource Server Main Page</h1>
<p th:text="'Hello, ' + ${name} + '! Your email is ' + ${email}"></p>
<a th:href="@{/admin}">Go to Admin Page</a><br>

<button onclick="getAccessToken()">Get Access Token</button>
<button onclick="getUserInfo()">Get User Info</button>

<div id="userInfo"></div>

<p>Access Token: <span id="accessToken"></span></p>

</body>
</html>
